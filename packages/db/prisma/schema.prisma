generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["auth", "public"]
}

model User {
  id                  String   @id @default(cuid())
  email               String   @unique
  name                String?
  roles               String[] @default(["member"]) // member, business, admin, governor
  status              UserStatus @default(PENDING)
  password            String?
  phone               String?  @unique  // E.164 format: +1XXXXXXXXXX
  walletAddress       String?  @unique
  encryptedPrivateKey String?  // Encrypted wallet private key for backend-managed wallets
  walletCreatedAt     DateTime? // Timestamp when wallet was created
  profileCompleted    Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Stripe integration for P2P payments
  stripeCustomerId       String?  @unique
  defaultPaymentMethodId String?

  // Relations
  application         Application?
  onrampTransactions  OnrampTransaction[]
  paymentMethods      PaymentMethod[]
  sentTransfers       P2PTransfer[] @relation("sender")
  receivedTransfers   P2PTransfer[] @relation("recipient")
  pendingTransfersSent PendingTransfer[] @relation("sender")
  bankAccounts        BankAccount[]
  withdrawals         Withdrawal[]
  notifications       Notification[]

  @@schema("public")
}

model Business {
  id          String   @id @default(cuid())
  ownerId     String
  name        String
  city        String
  isApproved  Boolean  @default(false)
  createdAt   DateTime @default(now())
  // ...other fields
  @@schema("public")
}

model Transaction {
  id          String   @id @default(cuid())
  fromUserId  String
  toBusinessId String?
  toUserId    String?
  amount      Float
  createdAt   DateTime @default(now())
  // ...other fields
  @@schema("public")
}

model WaitlistEntry {
  id        String   @id @default(cuid())
  email     String   @unique
  type      String   // "user" or "business"
  name      String?
  city      String?
  notes     String?
  source    String?  // "hero" or "contact"
  createdAt DateTime @default(now())
  @@schema("public")
}

model BusinessWaitlist {
  id              String   @id @default(cuid())
  ownerName       String
  ownerEmail      String   @unique
  businessName    String
  businessAddress String
  businessType    String
  monthlyRevenue  String
  description     String?
  createdAt       DateTime @default(now())
  @@schema("public")
}

// ── Application Models ────────────────────────────────
model Application {
  id          String   @id @default(cuid())
  userId      String   @unique
  status      ApplicationStatus @default(SUBMITTED)

  // Application data stored as JSON blob for flexibility
  data        Json

  // IPFS file uploads (CIDs - Content Identifiers)
  photoCID    String?  // Profile photo or ID photo
  videoCID    String?  // Introduction video (optional)
  documentCID String?  // Additional supporting documents

  // Review Process
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewNotes   String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("public")
}

// ── Proposal Engine Models ────────────────────────────
model Proposal {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  status      ProposalStatus @default(DRAFT)
  
  // Core proposal data
  title       String
  summary     String
  category    ProposalCategory
  
  // Proposer information
  proposerWallet     String
  proposerRole       ProposerRole
  proposerDisplayName String?
  
  // Region and budget
  regionCode         String
  regionName         String
  budgetCurrency     Currency
  budgetAmount       Float
  
  // Treasury plan
  localPercent       Float
  nationalPercent    Float
  acceptUC           Boolean @default(true)
  
  // Impact metrics
  leakageReductionUSD Float @default(0)
  jobsCreated        Int @default(0)
  timeHorizonMonths  Int @default(12)
  
  // AI scores
  alignmentScore     Float
  feasibilityScore   Float
  compositeScore     Float
  
  // Governance settings
  quorumPercent              Float @default(20)
  approvalThresholdPercent   Float @default(60)
  votingWindowDays           Int @default(7)
  
  // Audit trail
  engineVersion      String
  
  // Relations
  kpis               ProposalKPI[]
  auditChecks        ProposalAuditCheck[]
  votes              ProposalVote[]
  
  @@schema("public")
}

model ProposalKPI {
  id         String   @id @default(cuid())
  proposalId String
  name       String
  target     Float
  unit       KPIUnit
  
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  
  @@schema("public")
}

model ProposalAuditCheck {
  id         String   @id @default(cuid())
  proposalId String
  name       String
  passed     Boolean
  note       String?
  
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  
  @@schema("public")
}

model ProposalVote {
  id         String   @id @default(cuid())
  proposalId String
  voterWallet String
  vote       VoteType
  timestamp  DateTime @default(now())
  
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  
  @@unique([proposalId, voterWallet])
  @@schema("public")
}

// ── Admin Authentication Models ────────────────────────────────
model UserProfile {
  id            String   @id @default(cuid())
  walletAddress String   @unique
  username      String?  @unique // Username for transfer recipient lookup
  name          String
  email         String?
  phoneNumber   String
  role          String   @default("member")
  permissions   String[] @default([])
  lastLogin     DateTime?
  sessionToken  String?
  lastBalanceCheck DateTime?
  loginAttempts Int      @default(0)
  lastLoginAttempt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@schema("auth")
}

model AuthChallenge {
  id        String   @id @default(cuid())
  address   String
  nonce     String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([address])
  @@schema("auth")
}

model RateLimit {
  id        String   @id @default(cuid())
  key       String   @unique // IP address or wallet address
  count     Int      @default(0)
  resetAt   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@schema("auth")
}

model LoginCode {
  id        String   @id @default(cuid())
  email     String
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([email, code])
  @@schema("public")
}

// ── Enums ──────────────────────────────────────────
enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REJECTED
  
  @@schema("public")
}

enum ApplicationStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  
  @@schema("public")
}

enum ProposalStatus {
  DRAFT
  VOTABLE
  APPROVED
  FUNDED
  REJECTED
  
  @@schema("public")
}

enum ProposalCategory {
  BUSINESS_FUNDING
  PROCUREMENT
  INFRASTRUCTURE
  TRANSPORT
  WALLET_INCENTIVE
  GOVERNANCE
  OTHER
  
  @@schema("public")
}

enum ProposerRole {
  MEMBER
  MERCHANT
  ANCHOR
  BOT
  
  @@schema("public")
}

enum Currency {
  UC
  USD
  MIXED
  
  @@schema("public")
}

enum KPIUnit {
  USD
  UC
  JOBS
  PERCENT
  COUNT
  
  @@schema("public")
}

enum VoteType {
  FOR
  AGAINST
  ABSTAIN

  @@schema("public")
}

// ── Onramp Transaction Models ────────────────────────────
model OnrampTransaction {
  id                String        @id @default(cuid())
  userId            String
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  amountUSD         Float         // Amount paid in USD
  amountUC          Float         // UC tokens to mint (usually 1:1 peg)

  paymentIntentId   String        @unique // Payment ID from processor
  processor         String        // 'stripe', 'paypal', 'square' - which processor was used
  status            OnrampStatus  @default(PENDING)

  mintTxHash        String?       // Blockchain tx hash for UC minting
  processorChargeId String?       // Processor's charge/transaction ID

  createdAt         DateTime      @default(now())
  completedAt       DateTime?
  failedAt          DateTime?
  failureReason     String?

  @@index([userId, createdAt])
  @@index([processor, status])
  @@schema("public")
}

enum OnrampStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED

  @@schema("public")
}

// ── P2P Payment Models ────────────────────────────────

// Saved payment methods (cards) for P2P payments
model PaymentMethod {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripePaymentMethodId String   @unique
  type                  String   // 'card'
  last4                 String
  brand                 String   // visa, mastercard, amex
  expiryMonth           Int
  expiryYear            Int
  isDefault             Boolean  @default(false)

  createdAt             DateTime @default(now())

  @@index([userId])
  @@schema("public")
}

// P2P transfer between two Soulaan users
model P2PTransfer {
  id                String   @id @default(cuid())

  senderId          String
  sender            User     @relation("sender", fields: [senderId], references: [id])
  recipientId       String
  recipient         User     @relation("recipient", fields: [recipientId], references: [id])

  amountUSD         Float    // Display amount (what user sees)
  amountUC          Float    // Settlement amount (internal, same as USD at 1:1)

  // Funding source
  fundingSource     FundingSource  // BALANCE or CARD
  stripePaymentIntentId String?    // If funded by card
  stripeChargeId    String?

  // Settlement
  blockchainTxHash  String?
  status            P2PStatus @default(PENDING)

  note              String?
  createdAt         DateTime @default(now())
  completedAt       DateTime?
  failedAt          DateTime?
  failureReason     String?

  @@index([senderId, createdAt])
  @@index([recipientId, createdAt])
  @@index([status])
  @@schema("public")
}

// Pending transfer to non-user (escrow until claimed)
model PendingTransfer {
  id                String   @id @default(cuid())

  senderId          String
  sender            User     @relation("sender", fields: [senderId], references: [id])

  recipientPhone    String   // Phone number of non-user
  recipientEmail    String?  // Optional email

  amountUSD         Float
  amountUC          Float

  claimToken        String   @unique @default(cuid())  // For claim URL
  status            PendingStatus @default(PENDING_CLAIM)

  // Funding
  fundingSource     FundingSource
  stripePaymentIntentId String?
  stripeChargeId    String?

  note              String?
  expiresAt         DateTime  // 7 days from creation
  createdAt         DateTime @default(now())
  claimedAt         DateTime?
  claimedByUserId   String?   // User ID if they joined Soulaan
  refundedAt        DateTime?

  @@index([recipientPhone])
  @@index([claimToken])
  @@index([status, expiresAt])
  @@schema("public")
}

// Bank account for withdrawals
model BankAccount {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripeBankAccountId   String?  @unique
  accountHolderName     String
  bankName              String
  last4                 String   // Last 4 digits of account
  routingLast4          String   // Last 4 of routing number
  isDefault             Boolean  @default(false)
  isVerified            Boolean  @default(false)

  createdAt             DateTime @default(now())

  @@index([userId])
  @@schema("public")
}

// Withdrawal request (USD to bank)
model Withdrawal {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  bankAccountId     String

  amountUSD         Float
  amountUC          Float    // UC debited from balance

  stripePayoutId    String?  @unique
  status            WithdrawalStatus @default(PENDING)

  createdAt         DateTime @default(now())
  completedAt       DateTime?
  failedAt          DateTime?
  failureReason     String?

  @@index([userId, createdAt])
  @@index([status])
  @@schema("public")
}

// In-app notifications
model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        String   // PAYMENT_RECEIVED, PAYMENT_SENT, WITHDRAWAL_COMPLETE, etc.
  title       String
  body        String
  data        Json?    // Additional data (transferId, amount, etc)
  read        Boolean  @default(false)

  createdAt   DateTime @default(now())

  @@index([userId, read, createdAt])
  @@schema("public")
}

// ── P2P Enums ──────────────────────────────────────────

enum FundingSource {
  BALANCE    // Funded from existing UC balance
  CARD       // Funded via Stripe card charge

  @@schema("public")
}

enum P2PStatus {
  PENDING     // Transfer initiated
  PROCESSING  // Card charge or blockchain tx in progress
  COMPLETED   // Successfully settled
  FAILED      // Failed (card declined, blockchain error, etc.)

  @@schema("public")
}

enum PendingStatus {
  PENDING_CLAIM      // Waiting for recipient to claim
  CLAIMED_TO_BANK    // Recipient withdrew to bank (dead end)
  CLAIMED_TO_SOULAAN // Recipient joined Soulaan
  EXPIRED            // 7 days passed, refunded to sender

  @@schema("public")
}

enum WithdrawalStatus {
  PENDING     // Withdrawal requested
  PROCESSING  // Payout initiated with Stripe
  COMPLETED   // Funds sent to bank
  FAILED      // Payout failed

  @@schema("public")
}