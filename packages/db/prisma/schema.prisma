generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["auth", "public"]
}

model User {
  id                  String   @id @default(cuid())
  email               String   @unique
  name                String?
  roles               String[] @default(["member"]) // member, business, admin, governor
  status              UserStatus @default(PENDING)
  password            String?
  phone               String?  @unique  // E.164 format: +1XXXXXXXXXX
  walletAddress       String?  @unique
  encryptedPrivateKey String?  // Encrypted wallet private key for backend-managed wallets
  walletCreatedAt     DateTime? // Timestamp when wallet was created
  profileCompleted    Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Stripe integration for P2P payments
  stripeCustomerId       String?  @unique
  defaultPaymentMethodId String?

  // Relations
  application         Application?
  onrampTransactions  OnrampTransaction[]
  paymentMethods      PaymentMethod[]
  sentTransfers       P2PTransfer[] @relation("sender")
  receivedTransfers   P2PTransfer[] @relation("recipient")
  pendingTransfersSent PendingTransfer[] @relation("sender")
  bankAccounts        BankAccount[]
  withdrawals         Withdrawal[]
  notifications       Notification[]
  stores              Store[]
  scRewards           SCRewardTransaction[]

  @@schema("public")
}

model Business {
  id          String   @id @default(cuid())
  ownerId     String
  name        String
  city        String
  isApproved  Boolean  @default(false)
  createdAt   DateTime @default(now())
  // ...other fields
  @@schema("public")
}

model Transaction {
  id          String   @id @default(cuid())
  fromUserId  String
  toBusinessId String?
  toUserId    String?
  amount      Float
  createdAt   DateTime @default(now())
  // ...other fields
  @@schema("public")
}

model WaitlistEntry {
  id        String   @id @default(cuid())
  email     String   @unique
  type      String   // "user" or "business"
  name      String?
  city      String?
  notes     String?
  source    String?  // "hero" or "contact"
  createdAt DateTime @default(now())
  @@schema("public")
}

model BusinessWaitlist {
  id              String   @id @default(cuid())
  ownerName       String
  ownerEmail      String   @unique
  businessName    String
  businessAddress String
  businessType    String
  monthlyRevenue  String
  description     String?
  createdAt       DateTime @default(now())
  @@schema("public")
}

// ── Application Models ────────────────────────────────
model Application {
  id          String   @id @default(cuid())
  userId      String   @unique
  status      ApplicationStatus @default(SUBMITTED)

  // Application data stored as JSON blob for flexibility
  data        Json

  // IPFS file uploads (CIDs - Content Identifiers)
  photoCID    String?  // Profile photo or ID photo
  videoCID    String?  // Introduction video (optional)
  documentCID String?  // Additional supporting documents

  // Review Process
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewNotes   String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("public")
}

// ── Coop Configuration Models ────────────────────────────
model CoopConfig {
  id                        String   @id @default(cuid())
  coopId                    String
  version                   Int
  isActive                  Boolean  @default(true)
  charterText               String   @db.Text
  missionGoals              Json     // [{ key, label, priorityWeight, description? }]
  structuralWeights         Json     // { feasibility, risk, accountability } — sum to 1
  scoreMix                  Json     // { missionWeight, structuralWeight } — sum to 1
  screeningPassThreshold    Float    @default(0.6)  // 0..1
  quorumPercent             Float    @default(15)
  approvalThresholdPercent  Float    @default(51)
  votingWindowDays          Int      @default(7)
  scVotingCapPercent        Float    @default(2)
  proposalCategories        Json     // [{ key, label, isActive }]
  sectorExclusions          Json     // ["fashion", "restaurant", ...]
  scorerAgents              Json     @default("[]") // [{ agentKey, label, enabled, promptTemplate?, model? }]
  minScBalanceToSubmit      Float    @default(0)
  aiAutoApproveThresholdUSD Float    @default(500)
  councilVoteThresholdUSD   Float    @default(5000)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  createdBy                 String   // wallet address

  // Relations
  audits                    CoopConfigAudit[]

  @@unique([coopId, version])
  @@index([coopId, isActive])
  @@schema("public")
}

// Proposed change to any config section — must be acknowledged before going live
model ConfigAmendment {
  id               String    @id @default(cuid())
  coopId           String
  section          String                        // e.g. "missionGoals", "votingRules"
  proposedChanges  Json                          // { fieldName: newValue, ... }
  currentSnapshot  Json                          // snapshot of the fields being replaced
  reason           String
  status           String    @default("PENDING") // PENDING | ACKNOWLEDGED | REJECTED | SUPERSEDED
  proposedBy       String                        // wallet address
  proposedAt       DateTime  @default(now())
  reviewedBy       String?
  reviewedAt       DateTime?

  @@index([coopId, status])
  @@index([coopId, section, status])
  @@schema("public")
}

// Proposed charter text changes that must be acknowledged before going live
model CharterAmendment {
  id           String    @id @default(cuid())
  coopId       String
  proposedText String    @db.Text
  currentText  String    @db.Text   // snapshot of text being replaced
  reason       String
  status       String    @default("PENDING") // PENDING | ACKNOWLEDGED | REJECTED
  proposedBy   String                        // wallet address
  proposedAt   DateTime  @default(now())
  reviewedBy   String?                       // wallet address
  reviewedAt   DateTime?

  @@index([coopId, status])
  @@schema("public")
}

model CoopConfigAudit {
  id            String     @id @default(cuid())
  coopConfigId  String
  coopConfig    CoopConfig @relation(fields: [coopConfigId], references: [id], onDelete: Cascade)
  changedBy     String     // wallet address
  changedAt     DateTime   @default(now())
  reason        String
  diff          Json       // [{ field, before, after }]

  @@index([coopConfigId])
  @@schema("public")
}

// ── Proposal Engine Models ────────────────────────────
model Proposal {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  status      ProposalStatus @default(SUBMITTED)

  // Core proposal data
  title       String
  summary     String
  category    ProposalCategory

  // Proposer information
  proposerWallet     String
  proposerRole       ProposerRole
  proposerDisplayName String?

  // Region and budget
  regionCode         String
  regionName         String
  budgetCurrency     Currency
  budgetAmount       Float

  // Evaluation (new unified scoring model)
  evaluation         Json?           // EvaluationZ: structural_scores, mission_impact_scores, computed_scores, violations, risk_flags, llm_summary
  charterVersionId   String?         // snapshot of active CoopConfig.id at submission time

  // Governance settings
  quorumPercent              Float @default(20)
  approvalThresholdPercent   Float @default(60)
  votingWindowDays           Int @default(7)

  // Audit trail
  engineVersion      String

  // Enhanced engine output
  coopId             String?         // links to CoopConfig.coopId
  categoryKey        String?         // dynamic category from CoopConfig
  alternatives       Json?           // persisted Alternative[]
  bestAlternative    Json?           // top Alternative
  decision           String?         // "advance" | "revise" | "block"
  decisionReasons    String[]        // reason strings
  missingData        Json?           // MissingData[]

  // Original submission text (stored for re-submission / edit flow)
  rawText            String?         @db.Text

  // Governance additions
  councilRequired    Boolean         @default(false)
  withdrawnAt        DateTime?
  withdrawnBy        String?         // wallet address

  // Relations
  kpis               ProposalKPI[]
  auditChecks        ProposalAuditCheck[]
  votes              ProposalVote[]
  comments           ProposalComment[]
  reactions          ProposalReaction[]
  revisions          ProposalRevision[]

  @@schema("public")
}

model ProposalRevision {
  id             String   @id @default(cuid())
  proposalId     String
  revisionNumber Int
  submittedAt    DateTime @default(now())
  rawText        String?  @db.Text
  evaluation     Json?
  decision       String?
  decisionReasons String[]
  auditChecks    Json     // snapshot of audit checks at this revision
  status         String
  engineVersion  String

  proposal       Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)

  @@unique([proposalId, revisionNumber])
  @@schema("public")
}

// ── Expert Scoring Models ──────────────────────────────

/** Many-to-many mapping: a wallet can be expert for multiple domains */
model ExpertAssignment {
  id            String   @id @default(cuid())
  walletAddress String
  domain        String   // e.g. 'finance', 'market', 'community', 'ops', 'general'
  isActive      Boolean  @default(true)
  assignedBy    String   // admin wallet that granted the assignment
  assignedAt    DateTime @default(now())

  @@unique([walletAddress, domain])
  @@index([domain, isActive])
  @@schema("public")
}

/** Per-goal score record for a specific proposal revision.
 *  Stores both the AI score and optional expert override. */
model ProposalGoalScore {
  id             String   @id @default(cuid())
  proposalId     String
  revisionNumber Int
  goalId         String   // matches MissionGoal.key
  domain         String   // agent domain that produced the AI score
  aiScore        Float
  expertScore    Float?   // set when an expert provides an override
  finalScore     Float    // aiScore unless expertScore is set (override policy)
  expertWallet   String?  // wallet that submitted the expert override
  expertReason   String?  // rationale for the override
  updatedAt      DateTime @updatedAt

  adjustmentLog  ProposalScoreAdjustmentLog[]

  @@unique([proposalId, revisionNumber, goalId])
  @@index([proposalId, revisionNumber])
  @@index([domain])
  @@schema("public")
}

/** Immutable audit trail of every expert score change */
model ProposalScoreAdjustmentLog {
  id           String   @id @default(cuid())
  goalScoreId  String
  fromScore    Float
  toScore      Float
  reason       String
  expertWallet String
  createdAt    DateTime @default(now())

  goalScore    ProposalGoalScore @relation(fields: [goalScoreId], references: [id], onDelete: Cascade)

  @@index([goalScoreId])
  @@index([expertWallet, createdAt])
  @@schema("public")
}

model ProposalKPI {
  id         String   @id @default(cuid())
  proposalId String
  name       String
  target     Float
  unit       KPIUnit
  
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  
  @@schema("public")
}

model ProposalAuditCheck {
  id         String   @id @default(cuid())
  proposalId String
  name       String
  passed     Boolean
  note       String?
  
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  
  @@schema("public")
}

model ProposalVote {
  id         String   @id @default(cuid())
  proposalId String
  voterWallet String
  vote       VoteType
  timestamp  DateTime @default(now())
  
  proposal   Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  
  @@unique([proposalId, voterWallet])
  @@schema("public")
}

model ProposalComment {
  id            String   @id @default(cuid())
  proposalId    String
  proposal      Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  authorWallet  String
  authorName    String?
  content       String   @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  aiEvaluation  CommentAIEvaluation?

  @@index([proposalId, createdAt])
  @@schema("public")
}

model ProposalReaction {
  id          String       @id @default(cuid())
  proposalId  String
  proposal    Proposal     @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  voterWallet String
  reaction    ReactionType
  createdAt   DateTime     @default(now())

  @@unique([proposalId, voterWallet])
  @@index([proposalId])
  @@schema("public")
}

model CommentAIEvaluation {
  id            String           @id @default(cuid())
  commentId     String           @unique
  comment       ProposalComment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  alignment     CommentAlignment
  score         Float            // 0-1
  analysis      String           @db.Text
  goalsImpacted String[]
  createdAt     DateTime         @default(now())

  @@schema("public")
}

// ── Admin Authentication Models ────────────────────────────────
model UserProfile {
  id            String   @id @default(cuid())
  walletAddress String   @unique
  username      String?  @unique // Username for transfer recipient lookup
  name          String
  email         String?
  phoneNumber   String
  role          String   @default("member")
  permissions   String[] @default([])
  lastLogin     DateTime?
  sessionToken  String?
  lastBalanceCheck DateTime?
  loginAttempts Int      @default(0)
  lastLoginAttempt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@schema("auth")
}

model AuthChallenge {
  id        String   @id @default(cuid())
  address   String
  nonce     String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([address])
  @@schema("auth")
}

model RateLimit {
  id        String   @id @default(cuid())
  key       String   @unique // IP address or wallet address
  count     Int      @default(0)
  resetAt   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@schema("auth")
}

model LoginCode {
  id        String   @id @default(cuid())
  email     String
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([email, code])
  @@schema("public")
}

// ── Enums ──────────────────────────────────────────
enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REJECTED
  
  @@schema("public")
}

enum ApplicationStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  
  @@schema("public")
}

enum ProposalStatus {
  SUBMITTED
  VOTABLE
  APPROVED
  FUNDED
  REJECTED
  FAILED
  WITHDRAWN

  @@schema("public")
}

enum ReactionType {
  SUPPORT
  CONCERN

  @@schema("public")
}

enum ProposalCategory {
  BUSINESS_FUNDING
  PROCUREMENT
  INFRASTRUCTURE
  TRANSPORT
  WALLET_INCENTIVE
  GOVERNANCE
  OTHER
  
  @@schema("public")
}

enum ProposerRole {
  MEMBER
  MERCHANT
  ANCHOR
  BOT
  
  @@schema("public")
}

enum Currency {
  UC
  USD
  MIXED
  
  @@schema("public")
}

enum KPIUnit {
  USD
  UC
  JOBS
  PERCENT
  COUNT
  
  @@schema("public")
}

enum VoteType {
  FOR
  AGAINST
  ABSTAIN

  @@schema("public")
}

enum CommentAlignment {
  ALIGNED
  NEUTRAL
  MISALIGNED

  @@schema("public")
}

// ── Onramp Transaction Models ────────────────────────────
model OnrampTransaction {
  id                String        @id @default(cuid())
  userId            String
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  amountUSD         Float         // Amount paid in USD
  amountUC          Float         // UC tokens to mint (usually 1:1 peg)

  paymentIntentId   String        @unique // Payment ID from processor
  processor         String        // 'stripe', 'paypal', 'square' - which processor was used
  status            OnrampStatus  @default(PENDING)

  mintTxHash        String?       // Blockchain tx hash for UC minting
  processorChargeId String?       // Processor's charge/transaction ID

  createdAt         DateTime      @default(now())
  completedAt       DateTime?
  failedAt          DateTime?
  failureReason     String?

  @@index([userId, createdAt])
  @@index([processor, status])
  @@schema("public")
}

enum OnrampStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED

  @@schema("public")
}

// ── P2P Payment Models ────────────────────────────────

// Saved payment methods (cards) for P2P payments
model PaymentMethod {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripePaymentMethodId String   @unique
  type                  String   // 'card'
  last4                 String
  brand                 String   // visa, mastercard, amex
  expiryMonth           Int
  expiryYear            Int
  isDefault             Boolean  @default(false)

  createdAt             DateTime @default(now())

  @@index([userId])
  @@schema("public")
}

// P2P transfer between two Soulaan users
model P2PTransfer {
  id                String   @id @default(cuid())

  senderId          String
  sender            User     @relation("sender", fields: [senderId], references: [id])
  recipientId       String
  recipient         User     @relation("recipient", fields: [recipientId], references: [id])

  amountUSD         Float    // Display amount (what user sees)
  amountUC          Float    // Settlement amount (internal, same as USD at 1:1)

  // Funding source
  fundingSource     FundingSource  // BALANCE or CARD
  stripePaymentIntentId String?    // If funded by card
  stripeChargeId    String?

  // Settlement
  blockchainTxHash  String?
  status            P2PStatus @default(PENDING)

  // Transfer intent labeling
  transferType      TransferType @default(PERSONAL)
  transferMetadata  Json?       // Optional context (rentMonth, providerRole, storeName, etc.)

  note              String?
  createdAt         DateTime @default(now())
  completedAt       DateTime?
  failedAt          DateTime?
  failureReason     String?

  // Receipt created on completion
  receipt           Receipt?

  // Store payment request (if originated from one)
  paymentRequest    StorePaymentRequest?

  @@index([senderId, createdAt])
  @@index([recipientId, createdAt])
  @@index([status])
  @@index([transferType])
  @@schema("public")
}

// Pending transfer to non-user (escrow until claimed)
model PendingTransfer {
  id                String   @id @default(cuid())

  senderId          String
  sender            User     @relation("sender", fields: [senderId], references: [id])

  recipientPhone    String   // Phone number of non-user
  recipientEmail    String?  // Optional email

  amountUSD         Float
  amountUC          Float

  claimToken        String   @unique @default(cuid())  // For claim URL
  status            PendingStatus @default(PENDING_CLAIM)

  // Funding
  fundingSource     FundingSource
  stripePaymentIntentId String?
  stripeChargeId    String?

  // Transfer intent labeling
  transferType      TransferType @default(PERSONAL)
  transferMetadata  Json?       // Optional context (rentMonth, providerRole, storeName, etc.)

  note              String?
  expiresAt         DateTime  // 7 days from creation
  createdAt         DateTime @default(now())
  claimedAt         DateTime?
  claimedByUserId   String?   // User ID if they joined Soulaan
  refundedAt        DateTime?

  // Receipt created on completion
  receipt           Receipt?

  @@index([recipientPhone])
  @@index([claimToken])
  @@index([status, expiresAt])
  @@index([transferType])
  @@schema("public")
}

// Immutable receipt for transfer verification
model Receipt {
  id                String   @id @default(cuid())

  // Link to transfer (one of these will be set)
  p2pTransferId     String?  @unique
  p2pTransfer       P2PTransfer? @relation(fields: [p2pTransferId], references: [id])
  pendingTransferId String?  @unique
  pendingTransfer   PendingTransfer? @relation(fields: [pendingTransferId], references: [id])

  // Copied from transfer (immutable snapshot)
  senderId          String
  recipientId       String?  // Null for pending transfers to non-users
  recipientPhone    String?  // For pending transfers

  amountUSD         Float
  transferType      TransferType
  metadata          Json?    // Snapshot of transferMetadata

  // Verification
  verificationStatus ReceiptVerificationStatus @default(UNVERIFIED)
  verifiedAt        DateTime?
  verifiedBy        String?  // User ID who verified

  createdAt         DateTime @default(now())

  @@index([senderId])
  @@index([recipientId])
  @@index([transferType])
  @@index([verificationStatus])
  @@schema("public")
}

// Bank account for withdrawals
model BankAccount {
  id                    String   @id @default(cuid())
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  stripeBankAccountId   String?  @unique
  accountHolderName     String
  bankName              String
  last4                 String   // Last 4 digits of account
  routingLast4          String   // Last 4 of routing number
  isDefault             Boolean  @default(false)
  isVerified            Boolean  @default(false)

  createdAt             DateTime @default(now())

  @@index([userId])
  @@schema("public")
}

// Withdrawal request (USD to bank)
model Withdrawal {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  bankAccountId     String

  amountUSD         Float
  amountUC          Float    // UC debited from balance

  stripePayoutId    String?  @unique
  status            WithdrawalStatus @default(PENDING)

  createdAt         DateTime @default(now())
  completedAt       DateTime?
  failedAt          DateTime?
  failureReason     String?

  @@index([userId, createdAt])
  @@index([status])
  @@schema("public")
}

// In-app notifications
model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        String   // PAYMENT_RECEIVED, PAYMENT_SENT, WITHDRAWAL_COMPLETE, etc.
  title       String
  body        String
  data        Json?    // Additional data (transferId, amount, etc)
  read        Boolean  @default(false)

  createdAt   DateTime @default(now())

  @@index([userId, read, createdAt])
  @@schema("public")
}

// ── P2P Enums ──────────────────────────────────────────

enum FundingSource {
  BALANCE    // Funded from existing UC balance
  CARD       // Funded via Stripe card charge

  @@schema("public")
}

enum P2PStatus {
  PENDING     // Transfer initiated
  PROCESSING  // Card charge or blockchain tx in progress
  COMPLETED   // Successfully settled
  FAILED      // Failed (card declined, blockchain error, etc.)

  @@schema("public")
}

enum TransferType {
  PERSONAL    // Personal transfer (gift, friends/family)
  RENT        // Rent payment
  SERVICE     // Service or work payment
  STORE       // Store/goods purchase

  @@schema("public")
}

enum ReceiptVerificationStatus {
  UNVERIFIED  // Default - not yet verified
  VERIFIED    // Verified by recipient or system
  DISPUTED    // Disputed by either party

  @@schema("public")
}

enum PendingStatus {
  PENDING_CLAIM      // Waiting for recipient to claim
  CLAIMED_TO_BANK    // Recipient withdrew to bank (dead end)
  CLAIMED_TO_SOULAAN // Recipient joined Soulaan
  EXPIRED            // 7 days passed, refunded to sender

  @@schema("public")
}

enum WithdrawalStatus {
  PENDING     // Withdrawal requested
  PROCESSING  // Payout initiated with Stripe
  COMPLETED   // Funds sent to bank
  FAILED      // Payout failed

  @@schema("public")
}

// ── Store/Marketplace Models ────────────────────────────

model Store {
  id                String   @id @default(cuid())
  ownerId           String
  owner             User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  name              String
  description       String?
  category          StoreCategory
  imageUrl          String?
  bannerUrl         String?

  // Quick Pay settings
  shortCode         String?  @unique  // e.g., "JOES-COFFEE" or "JC4K9X"
  acceptsQuickPay   Boolean  @default(true)

  // Location
  address           String?
  city              String?
  state             String?
  zipCode           String?

  // Contact
  phone             String?
  email             String?
  website           String?

  // SC Verification - stores that can earn SC from transactions
  isScVerified      Boolean  @default(false)
  scVerifiedAt      DateTime?
  acceptsUC         Boolean  @default(true)  // Accepts UC payments (20% discount)
  ucDiscountPercent Float    @default(20)    // Discount for UC payments

  // Community commitment - percentage of profits that go back to the coop
  communityCommitmentPercent Float @default(10)

  // Status
  status            StoreStatus @default(PENDING)
  isFeatured        Boolean  @default(false)

  // Stats
  totalSales        Float    @default(0)
  totalOrders       Int      @default(0)
  rating            Float?
  reviewCount       Int      @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  products          Product[]
  application       StoreApplication?
  orders            StoreOrder[]
  paymentRequests   StorePaymentRequest[]
  scRewards         SCRewardTransaction[]

  @@index([ownerId])
  @@index([status])
  @@index([category])
  @@index([shortCode])
  @@schema("public")
}

model Product {
  id                String   @id @default(cuid())
  storeId           String
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  name              String
  description       String?
  category          ProductCategory
  imageUrl          String?
  images            String[] // Additional images

  // Pricing
  priceUSD          Float
  compareAtPrice    Float?   // Original price for showing discounts (admin only)
  ucDiscountPrice   Float?   // Price when paying with UC (auto-calculated or custom)

  // Inventory
  sku               String?
  quantity          Int      @default(0)
  trackInventory    Boolean  @default(true)
  allowBackorder    Boolean  @default(false)

  // Status
  isActive          Boolean  @default(true)
  isFeatured        Boolean  @default(false)

  // Stats
  totalSold         Int      @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  orderItems        StoreOrderItem[]

  @@index([storeId])
  @@index([category])
  @@index([isActive])
  @@schema("public")
}

model StoreApplication {
  id                String   @id @default(cuid())
  storeId           String   @unique
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // Business information
  businessName      String
  businessAddress   String
  businessCity      String
  businessState     String
  businessZip       String

  // Owner information
  ownerName         String
  ownerEmail        String
  ownerPhone        String

  // Application details
  storeDescription           String   @default("") // Description of what the store sells/offers
  communityBenefitStatement  String   @default("") // How the store will benefit the community
  communityCommitmentPercent Float    @default(10) // Percentage of profits committed back to coop
  estimatedMonthlyRevenue    String?
  websiteUrl                 String?
  socialMediaUrls            String[]

  // Documents (optional)
  businessLicenseCID String?  // IPFS CID for business license

  // Review
  status            StoreApplicationStatus @default(PENDING)
  reviewedBy        String?
  reviewedAt        DateTime?
  reviewNotes       String?
  rejectionReason   String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@schema("public")
}

model StoreOrder {
  id                String   @id @default(cuid())
  storeId           String
  store             Store    @relation(fields: [storeId], references: [id])
  buyerId           String

  // Totals
  subtotalUSD       Float
  discountUSD       Float    @default(0)
  totalUSD          Float
  totalUC           Float?   // If paid with UC

  // Payment
  paymentMethod     PaymentType
  paymentStatus     PaymentStatus @default(PENDING)
  transactionHash   String?  // Blockchain tx if paid with UC

  // Fulfillment
  fulfillmentStatus FulfillmentStatus @default(PENDING)
  shippingAddress   String?
  trackingNumber    String?

  note              String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  items             StoreOrderItem[]
  scRewards         SCRewardTransaction[]

  @@index([storeId])
  @@index([buyerId])
  @@schema("public")
}

model StoreOrderItem {
  id                String   @id @default(cuid())
  orderId           String
  order             StoreOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId         String
  product           Product  @relation(fields: [productId], references: [id])

  quantity          Int
  priceUSD          Float    // Price at time of purchase
  totalUSD          Float

  @@schema("public")
}

// Store-initiated payment request (for QR codes and payment links)
model StorePaymentRequest {
  id                String   @id @default(cuid())
  storeId           String
  store             Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // Request details
  amount            Float?   // Optional - if null, customer enters amount
  description       String?  // e.g., "Coffee + Pastry"
  referenceId       String?  // Store's internal reference (receipt #, table #)

  // Access token for the payment link
  token             String   @unique @default(cuid())

  // Status tracking
  status            PaymentRequestStatus @default(PENDING)

  // Payment fulfillment (when paid)
  p2pTransferId     String?  @unique
  p2pTransfer       P2PTransfer? @relation(fields: [p2pTransferId], references: [id])
  paidByUserId      String?
  paidAt            DateTime?

  // Expiration (optional - for time-limited requests)
  expiresAt         DateTime?

  createdAt         DateTime @default(now())

  @@index([storeId, status])
  @@index([token])
  @@index([status, expiresAt])
  @@schema("public")
}

// ── Category Management Models ────────────────────────────

model StoreCategoryConfig {
  id          String   @id @default(cuid())
  key         String   @unique // e.g., "FOOD_BEVERAGE", "FOUNDER_STORE"
  label       String   // e.g., "Food & Beverage"
  isAdminOnly Boolean  @default(false) // If true, only admins can create stores in this category
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, sortOrder])
  @@schema("public")
}

model ProductCategoryConfig {
  id          String   @id @default(cuid())
  key         String   @unique // e.g., "FOOD", "FOUNDER_BADGES"
  label       String   // e.g., "Food", "Founder Badges"
  isAdminOnly Boolean  @default(false) // If true, only admins can create products in this category
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, sortOrder])
  @@schema("public")
}

// ── Store Enums ──────────────────────────────────────────

enum PaymentRequestStatus {
  PENDING     // Awaiting payment
  COMPLETED   // Payment received
  EXPIRED     // Time limit exceeded
  CANCELLED   // Store cancelled the request

  @@schema("public")
}

enum StoreCategory {
  FOOD_BEVERAGE
  RETAIL
  SERVICES
  HEALTH_WELLNESS
  ENTERTAINMENT
  EDUCATION
  PROFESSIONAL
  HOME_GARDEN
  AUTOMOTIVE
  FOUNDER_PACKAGE
  OTHER

  @@schema("public")
}

enum ProductCategory {
  FOOD
  BEVERAGES
  CLOTHING
  ELECTRONICS
  HOME
  BEAUTY
  HEALTH
  SPORTS
  TOYS
  BOOKS
  SERVICES
  FOUNDER_BADGES
  OTHER

  @@schema("public")
}

enum StoreStatus {
  PENDING      // Application submitted, awaiting review
  APPROVED     // Approved and active
  SUSPENDED    // Temporarily suspended
  REJECTED     // Application rejected

  @@schema("public")
}

enum StoreApplicationStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED

  @@schema("public")
}

enum PaymentType {
  CARD
  UC_BALANCE
  MIXED

  @@schema("public")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED

  @@schema("public")
}

enum FulfillmentStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED

  @@schema("public")
}

// ── SC Reward Tracking Models ────────────────────────────

model SCRewardTransaction {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  
  // Reward details
  amountSC      Float
  reason        SCRewardReason
  status        SCRewardStatus @default(PENDING)
  
  // Blockchain
  txHash        String?  @unique
  
  // Context - link to store purchase
  relatedStoreId   String?
  relatedStore     Store?  @relation(fields: [relatedStoreId], references: [id])
  relatedOrderId   String?
  relatedOrder     StoreOrder? @relation(fields: [relatedOrderId], references: [id])
  
  // On-chain event metadata (for trustless system auditability)
  metadata      Json?
  
  // Timestamps
  createdAt     DateTime @default(now())
  completedAt   DateTime?
  failedAt      DateTime?
  
  // Error tracking for retries
  failureReason String?
  retryCount    Int      @default(0)
  lastRetryAt   DateTime?
  
  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@index([relatedStoreId])
  @@index([relatedOrderId])
  @@schema("public")
}

enum SCRewardReason {
  STORE_PURCHASE_REWARD  // Customer reward for shopping
  STORE_SALE_REWARD      // Store owner reward for sale
  MANUAL_ADJUSTMENT      // Admin manual grant/adjustment

  @@schema("public")
}

enum SCRewardStatus {
  PENDING
  COMPLETED
  FAILED

  @@schema("public")
}